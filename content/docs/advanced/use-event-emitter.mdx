---
title: Components
description: Some builtin components
---

# [useEventEmitter](https://ahooks.js.org/zh-CN/hooks/use-event-emitter)

## ğŸ“– ç”¨æ³•

åˆ›å»ºä¸€ä¸ªäº‹ä»¶å‘å°„å™¨ï¼Œç”¨äºåœ¨ç»„ä»¶ä¹‹é—´ä¼ é€’äº‹ä»¶ã€‚

<ViewCode src="./use-event-emitter/demo.tsx" />

## ğŸ“„ [æºç ](https://github.com/alibaba/hooks/blob/master/packages/hooks/src/useEventEmitter/index.ts)

::: code-group

{/* prettier-ignore */}
```ts [useEventEmitter.ts]
import { useRef, useEffect } from 'react';

type Subscription<T> = (val: T) => void;

export class EventEmitter<T> {
  private subscriptions = new Set<Subscription<T>>();

  emit = (val: T) => {
    for (const subscription of this.subscriptions) {
      subscription(val);
    }
  };

  useSubscription = (callback: Subscription<T>) => {
    // eslint-disable-next-line react-hooks/rules-of-hooks
    const callbackRef = useRef<Subscription<T>>(undefined);
    callbackRef.current = callback;
    // eslint-disable-next-line react-hooks/rules-of-hooks
    useEffect(() => {
      function subscription(val: T) {
        if (callbackRef.current) {
          callbackRef.current(val);
        }
      }
      this.subscriptions.add(subscription);
      return () => {
        this.subscriptions.delete(subscription);
      };
    }, []);
  };
}

function useEventEmitter<T = void>() {
  const ref = useRef<EventEmitter<T>>(undefined);
  if (!ref.current) {
    ref.current = new EventEmitter();
  }
  return ref.current;
}

export default useEventEmitter;
```

:::

## ğŸ” è§£è¯»

å…ˆçœ‹ `EventEmitter` ç±»çš„å®ç°ã€‚

{/* prettier-ignore */}
```ts
export class EventEmitter<T> {
  // 1. ä½¿ç”¨ Set å­˜å‚¨è®¢é˜…è€…
  private subscriptions = new Set<Subscription<T>>();

  // 2. å®šä¹‰ emit æ–¹æ³•ï¼Œç”¨äºè§¦å‘äº‹ä»¶
  emit = (val: T) => {
    // 2.1. éå†è®¢é˜…è€…ï¼Œè°ƒç”¨æ¯ä¸ªè®¢é˜…è€…çš„å›è°ƒå‡½æ•°
    for (const subscription of this.subscriptions) {
      subscription(val);
    }
  };

  // 3. å®šä¹‰ useSubscription æ–¹æ³•ï¼Œç”¨äºè®¢é˜…äº‹ä»¶
  useSubscription = (callback: Subscription<T>) => {
    // 3.1. ä½¿ç”¨ useRef å­˜å‚¨è®¢é˜…è€…å›è°ƒå‡½æ•°
    // eslint-disable-next-line react-hooks/rules-of-hooks
    const callbackRef = useRef<Subscription<T>>(undefined);
    callbackRef.current = callback;
    // 3.2. ä½¿ç”¨ useEffect è®¢é˜…äº‹ä»¶
    // eslint-disable-next-line react-hooks/rules-of-hooks
    useEffect(() => {
      // 3.2.1. å®šä¹‰è®¢é˜…è€…å›è°ƒå‡½æ•°
      function subscription(val: T) {
        // 3.2.2. å¦‚æœè®¢é˜…è€…å›è°ƒå‡½æ•°å­˜åœ¨ï¼Œåˆ™è°ƒç”¨è¯¥å›è°ƒå‡½æ•°
        if (callbackRef.current) {
          callbackRef.current(val);
        }
      }
      // 3.2.3. å°†è®¢é˜…è€…å›è°ƒå‡½æ•°æ·»åŠ åˆ°è®¢é˜…è€…é›†åˆä¸­
      this.subscriptions.add(subscription);
      // 3.2.4. è¿”å›ä¸€ä¸ªæ¸…ç†å‡½æ•°ï¼Œç”¨äºåœ¨ç»„ä»¶å¸è½½æ—¶æ¸…ç†è®¢é˜…è€…
      return () => {
        this.subscriptions.delete(subscription);
      };
    }, []);
  };
}
```

å†æ¥çœ‹ `useEventEmitter` å‡½æ•°çš„å®ç°ã€‚

{/* prettier-ignore */}
```ts
function useEventEmitter<T = void>() {
  // 1. ä½¿ç”¨ useRef åˆ›å»ºä¸€ä¸ª ref å¯¹è±¡ï¼Œç”¨äºå­˜å‚¨ EventEmitter å®ä¾‹
  const ref = useRef<EventEmitter<T>>(undefined);
  // 2. å¦‚æœ ref å¯¹è±¡ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ª EventEmitter å®ä¾‹
  if (!ref.current) {
    // 2.1. åˆ›å»ºä¸€ä¸ª EventEmitter å®ä¾‹
    ref.current = new EventEmitter();
  }
  // 3. è¿”å› EventEmitter å®ä¾‹
  return ref.current;
}
```

å…¶å®å°±æ˜¯ä¸€ä¸ª `EventBus` çš„ `hook` ç‰ˆæœ¬ï¼Œåœ¨ `EventBus` çš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†å½“ç»„ä»¶å¸è½½æ—¶æ¸…ç†è®¢é˜…è€…çš„åŠŸèƒ½ã€‚ä»¥åŠåœ¨ç»„ä»¶çš„é¡¶å±‚è°ƒç”¨è®¢é˜…äº‹ä»¶ `useSubscription`ï¼Œå› ä¸ºå¯¹äºä¸€ä¸ªç»„ä»¶æ¥è¯´ï¼Œåªéœ€è¦è®¢é˜…ä¸€æ¬¡ï¼Œä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆè®¢é˜…å‡½æ•°æ˜¯ä¸€ä¸ª `hook`ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ™®é€šçš„å‡½æ•°ï¼Œä»…éœ€è¦åœ¨é¡¶å±‚è°ƒç”¨ä¸€æ¬¡ `useSubscription` å³å¯ã€‚

è€Œå½“å‰çš„ `EventEmitter` ä»…æ”¯æŒå‘å¸ƒè€…å‘å¸ƒå”¯ä¸€äº‹ä»¶ï¼Œå¦‚æœéœ€è¦å‘å¸ƒå¤šä¸ªäº‹ä»¶ï¼Œé‚£å°±éœ€è¦åˆ›å»ºå¤šä¸ª `EventEmitter` å®ä¾‹äº†ã€‚å…¶å®æ ¹æ®ç®€å•æ”¹é€ ä¸€ä¸‹å°±èƒ½æ”¯æŒå¤šäº‹ä»¶å‘å¸ƒè®¢é˜…ã€‚

<ViewCode src="./demo2.tsx" />
