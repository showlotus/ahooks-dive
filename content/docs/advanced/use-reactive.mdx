---
title: Components
description: Some builtin components
---

# [useReactive](https://ahooks.js.org/zh-CN/hooks/use-reactive)

## ğŸ“– ç”¨æ³•

æä¾›ä¸€ä¸ªå“åº”å¼å¯¹è±¡ï¼Œå½“å¯¹è±¡çš„å±æ€§å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šè‡ªåŠ¨æ›´æ–°é¡µé¢ã€‚

<ViewCode src="./use-reactive/demo.tsx" />

## ğŸ“„ [æºç ](https://github.com/alibaba/hooks/blob/master/packages/hooks/src/useReactive/index.ts)

::: code-group

{/* prettier-ignore */}
```ts [useReactive.ts]
import { useRef } from 'react';
import isPlainObject from 'lodash/isPlainObject';
import useCreation from '../useCreation';
import useUpdate from '../useUpdate';

// k:v åŸå¯¹è±¡:ä»£ç†è¿‡çš„å¯¹è±¡
const proxyMap = new WeakMap();
// k:v ä»£ç†è¿‡çš„å¯¹è±¡:åŸå¯¹è±¡
const rawMap = new WeakMap();

function observer<T extends Record<string, any>>(initialVal: T, cb: () => void): T {
  const existingProxy = proxyMap.get(initialVal);

  // æ·»åŠ ç¼“å­˜ é˜²æ­¢é‡æ–°æ„å»ºproxy
  if (existingProxy) {
    return existingProxy;
  }

  // é˜²æ­¢ä»£ç†å·²ç»ä»£ç†è¿‡çš„å¯¹è±¡
  // https://github.com/alibaba/hooks/issues/839
  if (rawMap.has(initialVal)) {
    return initialVal;
  }

  const proxy = new Proxy<T>(initialVal, {
    get(target, key, receiver) {
      const res = Reflect.get(target, key, receiver);

      // https://github.com/alibaba/hooks/issues/1317
      const descriptor = Reflect.getOwnPropertyDescriptor(target, key);
      if (!descriptor?.configurable && !descriptor?.writable) {
        return res;
      }

      // Only proxy plain object or array,
      // otherwise it will cause: https://github.com/alibaba/hooks/issues/2080
      return isPlainObject(res) || Array.isArray(res) ? observer(res, cb) : res;
    },
    set(target, key, val) {
      const ret = Reflect.set(target, key, val);
      cb();
      return ret;
    },
    deleteProperty(target, key) {
      const ret = Reflect.deleteProperty(target, key);
      cb();
      return ret;
    },
  });

  proxyMap.set(initialVal, proxy);
  rawMap.set(proxy, initialVal);

  return proxy;
}

function useReactive<S extends Record<string, any>>(initialState: S): S {
  const update = useUpdate();
  const stateRef = useRef<S>(initialState);

  const state = useCreation(() => {
    return observer(stateRef.current, () => {
      update();
    });
  }, []);

  return state;
}

export default useReactive;
```

:::

## ğŸ” è§£è¯»

::: tip
å…³äº `useCreation`ã€`useUpdate`ï¼Œå¯ä»¥æŸ¥çœ‹å¯¹åº”æ–‡æ¡£ï¼š[useCreation](../../advanced/use-creation/)ã€[useUpdate](../../effect/use-update/)ã€‚
:::

å…ˆçœ‹ `observer` å‡½æ•°ï¼Œç”¨äºæ·±åº¦ä»£ç†ä¸€ä¸ªå¯¹è±¡ã€‚

{/* prettier-ignore */}
```ts
// k:v åŸå¯¹è±¡:ä»£ç†è¿‡çš„å¯¹è±¡
const proxyMap = new WeakMap();
// k:v ä»£ç†è¿‡çš„å¯¹è±¡:åŸå¯¹è±¡
const rawMap = new WeakMap();

function observer<T extends Record<string, any>>(initialVal: T, cb: () => void): T {
  // 1. åœ¨ proxyMap ä¸­æŸ¥æ‰¾å½“å‰å¯¹è±¡æ˜¯å¦å·²ç»ä»£ç†è¿‡
  const existingProxy = proxyMap.get(initialVal);

  // æ·»åŠ ç¼“å­˜ é˜²æ­¢é‡æ–°æ„å»ºproxy
  // 2. å¦‚æœå·²ç»ä»£ç†è¿‡ï¼Œåˆ™ç›´æ¥è¿”å›ä»£ç†è¿‡çš„å¯¹è±¡
  if (existingProxy) {
    return existingProxy;
  }

  // é˜²æ­¢ä»£ç†å·²ç»ä»£ç†è¿‡çš„å¯¹è±¡
  // https://github.com/alibaba/hooks/issues/839
  // 3. å¦‚æœå½“å‰å¯¹è±¡æ˜¯ä¸ªå·²ç»ä»£ç†è¿‡çš„å¯¹è±¡ï¼Œåˆ™ç›´æ¥è¿”å›è¯¥å¯¹è±¡
  if (rawMap.has(initialVal)) {
    return initialVal;
  }

  // 4. æ„å»ºä»£ç†å¯¹è±¡
  const proxy = new Proxy<T>(initialVal, {
    get(target, key, receiver) {
      // 4.1. é€šè¿‡ Reflect.get è·å–å½“å‰å¯¹è±¡çš„å±æ€§å€¼ï¼Œå¯ç¡®ä¿ this æŒ‡å‘çš„æ­£ç¡®æ€§
      const res = Reflect.get(target, key, receiver);

      // https://github.com/alibaba/hooks/issues/1317
      // 4.2. è·å–å½“å‰å¯¹è±¡çš„å±æ€§æè¿°ç¬¦ï¼Œå¦‚æœå±æ€§æè¿°ç¬¦ä¸å¯é…ç½®ä¸”ä¸å¯å†™ï¼Œåˆ™ç›´æ¥è¿”å›è¯¥å±æ€§
      const descriptor = Reflect.getOwnPropertyDescriptor(target, key);
      if (!descriptor?.configurable && !descriptor?.writable) {
        return res;
      }

      // Only proxy plain object or array,
      // otherwise it will cause: https://github.com/alibaba/hooks/issues/2080
      // 4.3. å¦‚æœå½“å‰å¯¹è±¡æ˜¯æ™®é€šå¯¹è±¡æˆ–æ•°ç»„ï¼Œåˆ™é€’å½’ä»£ç†è¯¥å¯¹è±¡
      return isPlainObject(res) || Array.isArray(res) ? observer(res, cb) : res;
    },
    set(target, key, val) {
      // 4.4. é€šè¿‡ Reflect.set è®¾ç½®å½“å‰å¯¹è±¡çš„å±æ€§å€¼ï¼Œå¹¶è§¦å‘å›è°ƒ
      const ret = Reflect.set(target, key, val);
      cb();
      return ret;
    },
    deleteProperty(target, key) {
      // 4.5. é€šè¿‡ Reflect.deleteProperty åˆ é™¤å½“å‰å¯¹è±¡çš„å±æ€§ï¼Œå¹¶è§¦å‘å›è°ƒ
      const ret = Reflect.deleteProperty(target, key);
      cb();
      return ret;
    },
  });

  // 5. å°†åŸå¯¹è±¡å’Œä»£ç†å¯¹è±¡åˆ†åˆ«ç¼“å­˜åˆ° proxyMap å’Œ rawMap ä¸­
  proxyMap.set(initialVal, proxy);
  rawMap.set(proxy, initialVal);

  // 6. è¿”å›ä»£ç†å¯¹è±¡
  return proxy;
}
```

å†æ¥çœ‹çœ‹ `useReactive` å‡½æ•°çš„å®ç°ã€‚

{/* prettier-ignore */}
```ts
function useReactive<S extends Record<string, any>>(initialState: S): S {
  // 1. ä½¿ç”¨ useUpdate è·å–æ›´æ–°å‡½æ•°ï¼Œè°ƒç”¨ update ä¼šè§¦å‘ç»„ä»¶é‡æ–°æ¸²æŸ“
  const update = useUpdate();
  // 2. ä½¿ç”¨ useRef åˆ›å»ºä¸€ä¸ª ref å¯¹è±¡ï¼Œç”¨äºå­˜å‚¨åˆå§‹çŠ¶æ€
  const stateRef = useRef<S>(initialState);

  // 3. ä½¿ç”¨ useCreation åˆ›å»ºä¸€ä¸ªå“åº”å¼å¯¹è±¡
  const state = useCreation(() => {
    // 3.1. è°ƒç”¨ observer å‡½æ•°ï¼Œæ·±åº¦ä»£ç†åˆå§‹çŠ¶æ€
    return observer(stateRef.current, () => {
      // 3.2. å½“å¯¹è±¡çš„å±æ€§å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè§¦å‘ update å‡½æ•°ï¼Œä»è€Œè§¦å‘ç»„ä»¶é‡æ–°æ¸²æŸ“
      update();
    });
  }, []);

  // 4. è¿”å›å“åº”å¼å¯¹è±¡
  return state;
}
```
