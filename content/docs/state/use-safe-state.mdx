---
title: Components
description: Some builtin components
---

# [useSafeState](https://ahooks.js.org/zh-CN/hooks/use-safe-state)

## ğŸ“– ç”¨æ³•

ç»„ä»¶å¸è½½åï¼Œä¸å†æ›´æ–°çŠ¶æ€ã€‚

<ViewCode src="./demo.tsx" />

## ğŸ“„ [æºç ](https://github.com/alibaba/hooks/blob/master/packages/hooks/src/useSafeState/index.ts)

::: code-group

{/* prettier-ignore */}
```ts [useSafeState.ts]
import { useCallback, useState } from 'react';
import type { Dispatch, SetStateAction } from 'react';
import useUnmountedRef from '../useUnmountedRef';

function useSafeState<S>(initialState: S | (() => S)): [S, Dispatch<SetStateAction<S>>];

function useSafeState<S = undefined>(): [S | undefined, Dispatch<SetStateAction<S | undefined>>];

function useSafeState<S>(initialState?: S | (() => S)) {
  const unmountedRef = useUnmountedRef();
  const [state, setState] = useState(initialState);
  const setCurrentState = useCallback((currentState: S) => {
    /** if component is unmounted, stop update */
    if (unmountedRef.current) {
      return;
    }
    setState(currentState);
  }, []);

  return [state, setCurrentState] as const;
}

export default useSafeState;
```

:::

## ğŸ” è§£è¯»

::: tip
å…³äº `useUnmountedRef`ï¼Œå¯ä»¥æŸ¥çœ‹å¯¹åº”æ–‡æ¡£ï¼š[useUnmountedRef](../../life-cycle/use-unmounted-ref/)ã€‚
:::

å†…éƒ¨ä½¿ç”¨ `useUnmountedRef` æ¥åˆ¤æ–­ç»„ä»¶æ˜¯å¦å·²ç»å¸è½½ï¼Œå¦‚æœå·²ç»å¸è½½ï¼Œåˆ™ä¸è¿›è¡Œæ›´æ–°ã€‚

{/* prettier-ignore */}
```ts
function useSafeState<S>(initialState?: S | (() => S)) {
  const unmountedRef = useUnmountedRef(); // [!code focus:1]
  const [state, setState] = useState(initialState);
  const setCurrentState = useCallback((currentState: S) => {
    /** if component is unmounted, stop update */
    if (unmountedRef.current) { // [!code focus:3]
      return;
    }
    setState(currentState);
  }, []);

  return [state, setCurrentState] as const;
}
```

å†…éƒ¨å®šä¹‰ `setCurrentState` ä½œä¸ºæ›´æ–°å‡½æ•°ï¼Œå¹¶ä½¿ç”¨ `useCallback` ç¼“å­˜å‡½æ•°å¼•ç”¨ï¼Œé¿å…é‡å¤åˆ›å»ºå‡½æ•°ï¼Œå¯¼è‡´é‡æ¸²æŸ“ã€‚

{/* prettier-ignore */}
```ts
function useSafeState<S>(initialState?: S | (() => S)) {
  const unmountedRef = useUnmountedRef();
  const [state, setState] = useState(initialState);
  const setCurrentState = useCallback((currentState: S) => { // [!code focus:7]
    /** if component is unmounted, stop update */
    if (unmountedRef.current) {
      return;
    }
    setState(currentState);
  }, []);

  return [state, setCurrentState] as const;
}
```

æœ€åè¿”å› `state` å’Œ `setCurrentState`ã€‚

{/* prettier-ignore */}
```ts
function useSafeState<S>(initialState?: S | (() => S)) {
  const unmountedRef = useUnmountedRef();
  const [state, setState] = useState(initialState);
  const setCurrentState = useCallback((currentState: S) => {
    /** if component is unmounted, stop update */
    if (unmountedRef.current) {
      return;
    }
    setState(currentState);
  }, []);

  return [state, setCurrentState] as const; // [!code focus:1]
}
```
