---
title: Components
description: Some builtin components
---

# [useDeepCompareEffect](https://ahooks.js.org/zh-CN/hooks/use-deep-compare-effect)

## ğŸ“– ç”¨æ³•

ç”¨æ³•ä¸ `useEffect` ä¸€è‡´ï¼Œä¸åŒçš„æ˜¯ï¼Œä¼šæ·±åº¦æ¯”è¾ƒä¾èµ–ã€‚

<ViewCode src="./use-deep-compare-effect/use-deep-compare-effect.tsx" />

## ğŸ“„ [æºç ](https://github.com/alibaba/hooks/blob/master/packages/hooks/src/useDeepCompareEffect/index.tsx)

::: code-group

{/* prettier-ignore */}
```tsx [useDeepCompareEffect.tsx]
import { useEffect } from 'react';
import { createDeepCompareEffect } from '../createDeepCompareEffect';

export default createDeepCompareEffect(useEffect);
```

{/* prettier-ignore */}
```ts [createDeepCompareEffect.ts]
import { useRef } from 'react';
import type { DependencyList, useEffect, useLayoutEffect } from 'react';
import { depsEqual } from '../utils/depsEqual';

type EffectHookType = typeof useEffect | typeof useLayoutEffect;

type CreateUpdateEffect = (hook: EffectHookType) => EffectHookType;

export const createDeepCompareEffect: CreateUpdateEffect = (hook) => (effect, deps) => {
  const ref = useRef<DependencyList>(undefined);
  const signalRef = useRef<number>(0);
  if (deps === undefined || !depsEqual(deps, ref.current)) {
    signalRef.current += 1;
  }
  ref.current = deps;
  hook(effect, [signalRef.current]);
};
```

{/* prettier-ignore */}
```ts [depsEqual.ts]
import type { DependencyList } from 'react';
import isEqual from 'react-fast-compare';

export const depsEqual = (aDeps: DependencyList = [], bDeps: DependencyList = []) =>
  isEqual(aDeps, bDeps);
```

:::

## ğŸ” è§£è¯»

é¦–å…ˆè°ƒç”¨ `createDeepCompareEffect` å‡½æ•°ï¼Œä¼ å…¥ `useEffect` å‡½æ•°ã€‚

`createDeepCompareEffect` æ‰§è¡Œåè¿”å›ä¸€ä¸ªæ–°å‡½æ•°ã€‚æºç çš„å†™æ³•æœ‰äº›ç®€ç•¥ï¼Œå› ä¸ºç›´æ¥é€šè¿‡ç®­å¤´å‡½æ•°è¿”å›ä¸€ä¸ªæ–°å‡½æ•°ï¼Œæ‰€ä»¥å°±ç›´æ¥çœç•¥äº† `return` å’Œ `{}`ã€‚

å®é™…ç­‰åŒäºä¸‹é¢çš„å†™æ³•ï¼š

{/* prettier-ignore */}
```ts
export const createDeepCompareEffect: CreateUpdateEffect = (hook) => {
  return (effect, deps) => {
    const ref = useRef<DependencyList>(undefined);
    const signalRef = useRef<number>(0);
    if (deps === undefined || !depsEqual(deps, ref.current)) {
      signalRef.current += 1;
    }
    ref.current = deps;
    hook(effect, [signalRef.current]);
  }
};
```

åœ¨è§£è¯» `createDeepCompareEffect` å‡½æ•°ä¹‹å‰ï¼Œå…ˆæ¥æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼šå¦‚ä½•å®ç°ä¸€ä¸ªå¯ä»¥è‡ªå®šä¹‰æ¯”è¾ƒ `deps` çš„ `useEffect` çš„ `hook`ï¼Ÿ

é¦–å…ˆè‚¯å®šè¿˜æ˜¯è¦åœ¨ `useEffect` çš„åŸºç¡€ä¸Šå®ç°è¿™ä¸ª `hook`ã€‚è€Œç”±äº `useEffect` åªæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•° `effect` æ˜¯å›è°ƒå‡½æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•° `deps` æ˜¯ä¾èµ–æ•°ç»„ã€‚`effect` è‚¯å®šæ˜¯ä¸èƒ½å˜çš„ï¼Œé‚£å°±åªèƒ½å˜ `deps` äº†ã€‚é‚£ä¹ˆå¯ä»¥å°†è‡ªå®šä¹‰æ¯”è¾ƒçš„ç»“æœé€šè¿‡ `deps` ç›´æ¥ä¼ ç»™ `useEffect`ï¼Œå¦‚æœæ¯”è¾ƒçš„ç»“æœä¸º `false` æ—¶ï¼Œé‚£å°±è§¦å‘ `effect`ã€‚

æ‰€ä»¥éœ€è¦ä¸€ä¸ªå‚æ•°ç”¨æ¥ä¼ ç»™ `useEffect`ï¼Œå¹¶ä¸”å½“æ¯”è¾ƒç»“æœä¸º `false` æ—¶ï¼Œè¿™ä¸ªå‚æ•°èƒ½ä¸ä¸Šæ¬¡çš„å€¼ä¸åŒã€‚

é‚£ä¹ˆç®€å•ç‚¹å°±æ˜¯å°†è¿™ä¸ªå‚æ•°è®¾ç½®ä¸ºè‡ªå¢çš„ï¼Œæ¯å½“æ¯”è¾ƒç»“æœä¸º `false` æ—¶ï¼Œå°±è‡ªå¢ `1`ã€‚åŒæ—¶ç”¨ `useRef` è®°å½•æ¯æ¬¡æ¯”è¾ƒçš„ç»“æœã€‚

è€Œæ¯æ¬¡ä¼ å…¥çš„ `deps` åŒæ ·ä¹Ÿéœ€è¦ç”¨ `useRef` è®°å½•ï¼Œç”¨äºæ¯æ¬¡æ¯”è¾ƒæ—¶ï¼Œåˆ¤æ–­ `deps` æ˜¯å¦å‘ç”Ÿå˜åŒ–ã€‚

æ‰€ä»¥ï¼Œæœ€åå®ç°çš„ä»£ç å¦‚ä¸‹ï¼š

{/* prettier-ignore */}
```ts
import { useEffect, useRef } from 'react';

export const useCustomCompareEffect = (effect, deps, isEqual = Object.is) => {
  const depsRef = useRef(undefined);
  const signalRef = useRef(0);
  if (deps === undefined || !isEqual(deps, depsRef.current)) {
    signalRef.current += 1;
  }
  depsRef.current = deps;
  useEffect(effect, [signalRef.current]);
};
```

`useCustomCompareEffect` å‡½æ•°æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼š`effect` æ˜¯å›è°ƒå‡½æ•°ï¼Œ`deps` æ˜¯ä¾èµ–æ•°ç»„ï¼Œ`isEqual` æ˜¯è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°ã€‚

å¦‚æœ `isEqual` æœªä¼ å…¥ï¼Œåˆ™é»˜è®¤ä½¿ç”¨ `Object.is` è¿›è¡Œæ¯”è¾ƒã€‚å¹¶ä¸”å½“å‰çš„æ‰§è¡Œé€»è¾‘ä¸ `useEffect` ä¸€è‡´ã€‚

å‡½æ•°å†…éƒ¨å°† `depsRef` çš„åˆå§‹å€¼è®¾ç½®ä¸º `undefined`ï¼Œå› ä¸º `useEffect` çš„ `deps` æ˜¯å¯é€‰çš„ã€‚å¦‚æœæœªä¼ å…¥ï¼Œåˆ™éœ€è¦æ¯æ¬¡æ¸²æŸ“æ—¶éƒ½è§¦å‘ `effect`ã€‚

å†å°† `signalRef` çš„åˆå§‹å€¼è®¾ç½®ä¸º `0`ï¼Œç”¨äºåç»­è‡ªå¢ã€‚

æ¥ç€åˆ¤æ–­ `deps` æ˜¯å¦ä¸º `undefined`ï¼Œæˆ–è€…æ˜¯å¦ä¸ä¸Šæ¬¡è®°å½•çš„ `deps` ä¸ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´ï¼Œåˆ™è‡ªå¢ `signalRef`ã€‚

ç„¶åæ›´æ–° `depsRef` çš„å€¼ä¸ºå½“å‰æœ€æ–°çš„ `deps`ã€‚

æœ€åå°† `signalRef` çš„å€¼ä½œä¸º `deps` ä¼ ç»™ `useEffect`ï¼Œç”¨äºè§¦å‘ `effect`ã€‚

å°æµ‹ä¸€ä¸‹ï½

<ViewCode src="./use-deep-compare-effect/use-deep-compare-effect2.tsx" />

äº†è§£äº† `useCustomCompareEffect` çš„å®ç°åï¼Œè¿™æ—¶å€™å†çœ‹ `createDeepCompareEffect` çš„å®ç°ï¼Œä¸€åˆ‡éƒ½è±ç„¶å¼€æœ—äº†ã€‚

æ— éå°±æ˜¯åœ¨ `createDeepCompareEffect` å†…éƒ¨é»˜è®¤ç”¨ `react-fast-compare` çš„ `isEqual` æ¥æ¯”è¾ƒ `deps` æ˜¯å¦å‘ç”Ÿå˜åŒ–ã€‚å…¶ä½™éƒ¨åˆ†ä¸ `useCustomCompareEffect` ä¸€è‡´ã€‚

{/* prettier-ignore */}
```ts
export const createDeepCompareEffect: CreateUpdateEffect = (hook) => {
  return (effect, deps) => {
    const ref = useRef<DependencyList>(undefined);
    const signalRef = useRef<number>(0);
    if (deps === undefined || !depsEqual(deps, ref.current)) { // [!code highlight]
      signalRef.current += 1;
    }
    ref.current = deps;
    hook(effect, [signalRef.current]);
  }
};
```

å…³äº `react-fast-compare` çš„æ€§èƒ½ï¼Œä¸å…¶ä»–å¸¸ç”¨åº“å¯¹æ¯”äº†ä¸€ä¸‹ï¼š

{/* ![benchmark](./benchmark.png) */}

åœ¨å¯¹æ¯”åŸå§‹å€¼æ—¶ï¼Œ`react-fast-compare` çš„æ€§èƒ½å±…æœ«ï¼Œä½†å¯¹æ¯”å¯¹è±¡ã€æ•°ç»„æ—¶ï¼Œæ€§èƒ½ä½å±…å‰äºŒã€‚å°¤å…¶æ˜¯å¯¹è±¡çš„æ¯”å¯¹ï¼Œæµ‹äº†å¥½å‡ è½®ï¼Œä¸€ç›´æ˜¯ç¬¬ä¸€ã€‚å¯è§å…¶åœ¨ `React` ä¸­ç”¨æ¥å¯¹æ¯” `deps`ï¼Œè¿˜æ˜¯å¾ˆèƒ½æ‰“çš„ã€‚
